# Ocean Deep Audit (February 2026)

## Scope
- Full repository static audit across kernel, userspace servers, drivers, and shared headers.
- Correctness-first remediation of critical kernel defects that could crash or corrupt runtime state.
- Validation tooling expansion to support repeatable build + smoke + stress gates.

## Critical Findings and Fixes
1. User pointer safety gaps in syscall handlers
- Risk: direct dereference of user pointers in syscall paths (`read`, `write`, `debug_print`, `exec`, `wait`, IPC receive output).
- Fix: introduced centralized user access layer in `kernel/mm/uaccess.c` and `kernel/include/ocean/uaccess.h`; syscall handlers now use `copy_from_user`, `copy_to_user`, and `copy_string_from_user`.

2. IPC endpoint lifetime/use-after-free race
- Risk: `endpoint_destroy()` freed endpoints while references could still exist.
- Fix: converted to two-phase teardown: mark dead + remove from global list, free only at final `endpoint_put()` refcount drop.

3. IPC wait object lifetime hazards
- Risk: stack-backed wait objects were queued across scheduler handoffs.
- Fix: wait objects now allocate on heap and are defensively removed on wakeup paths to avoid dangling queue links.

4. Channel wakeups were effectively non-functional
- Risk: `thread_wakeup()` was a no-op, breaking generic sleep/wake flows.
- Fix: introduced global thread registry and real channel scanning wakeup in scheduler.

5. Process lifecycle leaks and zombie reaping gaps
- Risk: waited children were not fully reclaimed; failed fork paths leaked process objects.
- Fix: added `process_reap()` for full child cleanup, wired into `process_wait()`, and hardened fork failure cleanup.

6. Kernel thread entry argument bug
- Risk: kernel thread creation ignored function arguments.
- Fix: added `kthread_entry` trampoline passing function/arg via saved callee registers.

7. Memory accounting and allocator correctness bugs
- Risk: `vmm_unmap_region()` decremented `total_vm` by requested size instead of actual unmapped pages; slab free path mishandled large allocations.
- Fix: actual unmapped page accounting; slab now tags slab pages via `PG_SLAB` and frees compound allocations with correct order.

8. Page fault handling not integrated into exception path
- Risk: all exceptions halted system before VMM fault resolution could run.
- Fix: IDT exception path now forwards page faults to `page_fault_handler()` and returns on successful resolution.

## Remaining High-Value Work
- Complete IPC `call/reply/reply_recv` semantics and capability transfer enforcement.
- Replace simulated server behavior with end-to-end live IPC-backed operations across mem/proc/vfs/blk.
- Add deeper runtime stress/fault-injection for process and memory churn paths.
